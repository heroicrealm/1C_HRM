#Область ОбработчикиСобытийФормы

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	Организация = Параметры.Организация;
	ФизическоеЛицо = Параметры.ФизическоеЛицо;
	Начало = Параметры.Начало;
	Окончание = Параметры.Окончание;
	КоличествоДней = Параметры.КоличествоДней;
	СреднийЗаработок = Параметры.СреднийЗаработок;
	ВыходноеПособие = Параметры.ВыходноеПособие;
	Начислено = Параметры.Начислено;
	ЭтоСреднечасовойЗаработок = Параметры.ЭтоСреднечасовойЗаработок;
	
	УстановитьСвойстваЭлементовФормы();
	
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиСобытийЭлементовШапкиФормы

&НаКлиенте
Процедура НачалоПриИзменении(Элемент)
	
	РассчитатьКоличествоДнейНаСервере();
	РассчитатьСуммуНачислено();
	
КонецПроцедуры

&НаКлиенте
Процедура ОкончаниеПриИзменении(Элемент)
	
	РассчитатьКоличествоДнейНаСервере();
	РассчитатьСуммуНачислено();
	
КонецПроцедуры

&НаКлиенте
Процедура СреднийЗаработокПриИзменении(Элемент)
	
	РассчитатьСуммуНачислено();
	
КонецПроцедуры

&НаКлиенте
Процедура ВыходноеПособиеПриИзменении(Элемент)
	
	РассчитатьСуммуНачислено();
	
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиКомандФормы

&НаКлиенте
Процедура ОК(Команда)
	
	Если Модифицированность Тогда
		
		ДанныеСреднегоЗаработка = Новый Структура;
		ДанныеСреднегоЗаработка.Вставить("ФизическоеЛицо", ФизическоеЛицо);
		ДанныеСреднегоЗаработка.Вставить("Начало", Начало);
		ДанныеСреднегоЗаработка.Вставить("Окончание", Окончание);
		ДанныеСреднегоЗаработка.Вставить("КоличествоДней", КоличествоДней);
		ДанныеСреднегоЗаработка.Вставить("СреднийЗаработок", СреднийЗаработок);
		ДанныеСреднегоЗаработка.Вставить("Начислено", Начислено);
		ДанныеСреднегоЗаработка.Вставить("ВыходноеПособие", ВыходноеПособие); 
		ДанныеСреднегоЗаработка.Вставить("ЭтоСреднечасовойЗаработок", ЭтоСреднечасовойЗаработок);
		
		Оповестить("ИзмененСохраняемыйЗаработокНаВремяТрудоустройства", ДанныеСреднегоЗаработка, ЭтаФорма);
		Модифицированность = Ложь;
		
	КонецЕсли;
	
	Закрыть();	
	
КонецПроцедуры

&НаКлиенте
Процедура Отмена(Команда)
	
	Закрыть();	
	
КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

&НаКлиенте
Процедура РассчитатьСуммуНачислено()
	
	Начислено = СреднийЗаработок * КоличествоДней - ВыходноеПособие
	
КонецПроцедуры

&НаСервере
Процедура РассчитатьКоличествоДнейНаСервере()
	
	КоличествоДней = 0;
	
	Если Не ЗначениеЗаполнено(Начало) Или Не ЗначениеЗаполнено(Окончание) Тогда 
		Возврат;
	КонецЕсли;
	
	Период = Начало - 86400;
	Сотрудник = КадровыйУчет.ОсновнойСотрудникФизическогоЛица(ФизическоеЛицо, Организация, Период);
	
	ТаблицаСотрудников = Новый ТаблицаЗначений;
	ТаблицаСотрудников.Колонки.Добавить("Организация", Новый ОписаниеТипов("СправочникСсылка.Организации"));
	ТаблицаСотрудников.Колонки.Добавить("Сотрудник", Новый ОписаниеТипов("СправочникСсылка.Сотрудники"));
	ТаблицаСотрудников.Колонки.Добавить("ДатаНачалаПериода", Новый ОписаниеТипов("Дата"));
	ТаблицаСотрудников.Колонки.Добавить("ДатаОкончанияПериода", Новый ОписаниеТипов("Дата"));
	
	НоваяСтрока = ТаблицаСотрудников.Добавить();
	НоваяСтрока.Организация = Организация;
	НоваяСтрока.Сотрудник = Сотрудник;
	НоваяСтрока.ДатаНачалаПериода = Начало;
	НоваяСтрока.ДатаОкончанияПериода = Окончание;
	
	Запрос = Новый Запрос;
	
	Запрос.МенеджерВременныхТаблиц = Новый МенеджерВременныхТаблиц;
	
	УчетРабочегоВремениРасширенный.СоздатьВТВремяПоГрафикамСотрудников(ТаблицаСотрудников, Запрос.МенеджерВременныхТаблиц, Истина);
	
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	ДанныеКалендаря.ДатаНачалаПериода КАК НачалоПериода,
		|	ДанныеКалендаря.ДатаОкончанияПериода КАК ОкончаниеПериода,
		|	ДанныеКалендаря.ОтработаноДнейПоПроизводственномуКалендарю КАК КоличествоДней,
		|	ДанныеКалендаря.ОтработаноЧасовПоПроизводственномуКалендарю КАК КоличествоЧасов,
		|	ДанныеКалендаря.СуммированныйУчетРабочегоВремени
		|ИЗ
		|	ВТВремяПоГрафикамСотрудников КАК ДанныеКалендаря";
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Если Выборка.Количество() = 0 Тогда 
		Возврат;					   
	КонецЕсли;
	
	Выборка.Следующий();
	
	ЭтоСреднечасовойЗаработок = Выборка.СуммированныйУчетРабочегоВремени;
	КоличествоДней = ?(ЭтоСреднечасовойЗаработок, Выборка.КоличествоЧасов, Выборка.КоличествоДней);
	
	УстановитьСвойстваЭлементовФормы();
	
КонецПроцедуры

&НаСервере
Процедура УстановитьСвойстваЭлементовФормы()
	
	Представление = Строка(КоличествоДней) + " " + ?(ЭтоСреднечасовойЗаработок, НСтр("ru = 'ч.'"), НСтр("ru = 'дн.'"));
	ОбщегоНазначенияКлиентСервер.УстановитьСвойствоЭлементаФормы(Элементы, "КоличествоДнейНадпись", "Заголовок", Представление);
	
КонецПроцедуры

#КонецОбласти
